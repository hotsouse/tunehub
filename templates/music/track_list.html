{% extends 'base.html' %}
{% block title %}Tracks ¬∑ Catalog{% endblock %}
{% block content %}
<div class="page-header">
  <h1>üéµ –¢—Ä–µ–∫–∏</h1>
  <a href="/music/albums/" class="btn btn-secondary">–ê–ª—å–±–æ–º—ã</a>
</div>

<div class="search-sort-container">
  <form method="get" class="search-form" style="flex:1">
    <input type="text" name="q" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." value="{{ search_query }}" />
    <select name="genre" class="form-select" style="max-width:200px">
      <option value="">–í—Å–µ –∂–∞–Ω—Ä—ã</option>
      {% for g in genres %}
      <option value="{{ g.name }}" {% if request.GET.genre == g.name %}selected{% endif %}>{{ g.name }}</option>
      {% endfor %}
    </select>
    <select name="artist" class="form-select" style="max-width:200px">
      <option value="">–í—Å–µ –∞—Ä—Ç–∏—Å—Ç—ã</option>
      {% for a in artists %}
      <option value="{{ a.name }}" {% if request.GET.artist == a.name %}selected{% endif %}>{{ a.name }}</option>
      {% endfor %}
    </select>
    <select name="sort" class="form-select" style="max-width:180px">
      <option value="title" {% if request.GET.sort == 'title' %}selected{% endif %}>–ù–∞–∑–≤–∞–Ω–∏–µ</option>
      <option value="album__title" {% if request.GET.sort == 'album__title' %}selected{% endif %}>–ê–ª—å–±–æ–º</option>
      <option value="-title" {% if request.GET.sort == '-title' %}selected{% endif %}>–ù–∞–∑–≤–∞–Ω–∏–µ ‚Üì</option>
    </select>
    <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    <a href="/music/tracks/" class="btn btn-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
  </form>
</div>

<div class="grid">
  {% for t in page_obj %}
  <div class="card">
    <div class="card-header">
      <h3>{{ t.title }}</h3>
      <div class="card-badges">
        {% if t.genre %}<span class="year">{{ t.genre }}</span>{% endif %}
      </div>
    </div>
    <div class="card-body">
      <p><strong>–ê–ª—å–±–æ–º:</strong> {{ t.album }}</p>
      <p><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> {{ t.duration }}s</p>
    </div>
    <div class="card-actions">
      {% if request.user.is_authenticated %}
      <form method="post" action="/music/tracks/{{ t.id }}/favorite/">
        {% csrf_token %}
        <button class="btn btn-favorite" type="submit">–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
      </form>
      {% endif %}
    </div>
  </div>
  {% empty %}
  <div class="empty-state">
    <h3>–ù–µ—Ç —Ç—Ä–µ–∫–æ–≤</h3>
  </div>
  {% endfor %}
</div>

<nav class="mt-3 d-flex gap-2 flex-wrap align-items-center">
  {% with sq=search_query gf=request.GET.genre af=request.GET.artist sf=request.GET.sort %}
    {% if page_obj.has_previous %}
      <a class="btn btn-outline-secondary btn-sm" href="?q={{ sq }}&genre={{ gf }}&artist={{ af }}&sort={{ sf }}&page=1">First</a>
      <a class="btn btn-outline-secondary btn-sm" href="?q={{ sq }}&genre={{ gf }}&artist={{ af }}&sort={{ sf }}&page={{ page_obj.previous_page_number }}">Prev</a>
    {% endif %}
    <span class="text-muted small">–°—Ç—Ä. {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}</span>
    {% for num in page_obj.paginator.page_range %}
      {% if num == page_obj.number %}
        <span class="btn btn-primary btn-sm disabled">{{ num }}</span>
      {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
        <a class="btn btn-outline-secondary btn-sm" href="?q={{ sq }}&genre={{ gf }}&artist={{ af }}&sort={{ sf }}&page={{ num }}">{{ num }}</a>
      {% endif %}
    {% endfor %}
    {% if page_obj.has_next %}
      <a class="btn btn-outline-secondary btn-sm" href="?q={{ sq }}&genre={{ gf }}&artist={{ af }}&sort={{ sf }}&page={{ page_obj.next_page_number }}">Next</a>
      <a class="btn btn-outline-secondary btn-sm" href="?q={{ sq }}&genre={{ gf }}&artist={{ af }}&sort={{ sf }}&page={{ page_obj.paginator.num_pages }}">Last</a>
    {% endif %}
  {% endwith %}
</nav>
{% endblock %}

