{% extends "base.html" %}
{% load static %}

{% block title %}{{ movie.title }} - TuneHub{% endblock %}

{% block content %}
<section class="section">
    <!-- Back Button -->
    <div style="margin-bottom: 2rem;">
        <a href="{% url 'movies:movie_list' %}" class="btn btn-secondary">
            <i data-lucide="arrow-left"></i>
            Назад к фильмам
        </a>
    </div>
    
    <!-- Movie Header -->
    <div style="
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 24px;
        padding: 3rem;
        margin-bottom: 3rem;
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 3rem;
        align-items: start;
    ">
        <!-- Poster -->
        <div style="
            aspect-ratio: 2/3;
            border-radius: 16px;
            overflow: hidden;
            background: var(--gradient-primary);
            box-shadow: var(--shadow-lg);
        ">
            {% if movie.poster %}
                <img src="{{ movie.poster.url }}" alt="{{ movie.title }}" style="width: 100%; height: 100%; object-fit: cover;">
            {% else %}
                <div style="
                    width: 100%;
                    height: 100%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">
                    <i data-lucide="film" style="width: 80px; height: 80px; color: white; opacity: 0.5;"></i>
                </div>
            {% endif %}
        </div>
        
        <!-- Info -->
        <div>
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                <div style="flex: 1;">
                    <h1 style="
                        font-size: 2.5rem;
                        font-weight: 800;
                        margin-bottom: 0.5rem;
                        background: var(--gradient-primary);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        background-clip: text;
                    ">
                        {{ movie.title }}
                    </h1>
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                        <span class="year">{{ movie.release_year }}</span>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i data-lucide="star" style="width: 20px; height: 20px; color: #F59E0B;"></i>
                            <span style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary);">
                                {{ movie.rating|floatformat:1 }}
                            </span>
                        </div>
                    </div>
                </div>
                
                {% if request.user.is_authenticated %}
                    <form method="post" action="{% url 'movies:movie_favorite' movie.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn {% if is_favorited %}btn-secondary{% else %}btn-outline{% endif %}" style="
                            color: {% if is_favorited %}var(--secondary){% else %}var(--primary){% endif %};
                        ">
                            <i data-lucide="heart" style="
                                fill: {% if is_favorited %}currentColor{% else %}none{% endif %};
                            "></i>
                            {% if is_favorited %}В избранном{% else %}В избранное{% endif %}
                        </button>
                    </form>
                {% endif %}
            </div>
            
            <!-- Genres -->
            {% if movie.genres.all %}
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        {% for genre in movie.genres.all %}
                            <span class="badge">{{ genre.name }}</span>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
            
            <!-- Details -->
            <div style="margin-bottom: 1.5rem;">
                {% if movie.directors.all %}
                    <p style="margin-bottom: 0.75rem;">
                        <strong style="color: var(--text-primary);">Режиссёры:</strong>
                        <span style="color: var(--text-secondary);">{{ movie.directors.all|join:", " }}</span>
                    </p>
                {% endif %}
                
                {% if movie.actors.all %}
                    <p style="margin-bottom: 0.75rem;">
                        <strong style="color: var(--text-primary);">Актёры:</strong>
                        <span style="color: var(--text-secondary);">{{ movie.actors.all|join:", " }}</span>
                    </p>
                {% endif %}
            </div>
            
            <!-- Description -->
            {% if movie.description %}
                <div style="
                    padding: 1.5rem;
                    background: var(--bg-tertiary);
                    border-radius: 12px;
                    margin-bottom: 1.5rem;
                ">
                    <h3 style="
                        font-size: 1.125rem;
                        font-weight: 700;
                        margin-bottom: 0.75rem;
                        color: var(--text-primary);
                    ">
                        Описание
                    </h3>
                    <p style="
                        color: var(--text-secondary);
                        line-height: 1.7;
                        margin: 0;
                    ">
                        {{ movie.description }}
                    </p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Reviews Section -->
    <div style="margin-bottom: 3rem;">
        <h2 style="
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 2rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        ">
            Отзывы
        </h2>
        
        {% if reviews %}
            <div class="list-group">
                {% for review in reviews %}
                    <div class="list-group-item" style="flex-direction: column; align-items: flex-start; gap: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="
                                    width: 40px;
                                    height: 40px;
                                    border-radius: 50%;
                                    background: var(--gradient-primary);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: white;
                                    font-weight: 700;
                                ">
                                    {{ review.user.username|first|upper }}
                                </div>
                                <div>
                                    <strong style="color: var(--text-primary);">{{ review.user.username }}</strong>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.25rem;">
                                        <div style="display: flex; gap: 0.15rem;">
                                            {% for i in "12345" %}
                                                <i data-lucide="star" style="
                                                    width: 14px;
                                                    height: 14px;
                                                    color: {% if forloop.counter <= review.rating %}#F59E0B{% else %}var(--text-muted){% endif %};
                                                    {% if forloop.counter <= review.rating %}fill: currentColor;{% endif %}
                                                "></i>
                                            {% endfor %}
                                        </div>
                                        <span style="color: var(--text-muted); font-size: 0.875rem;">
                                            {{ review.created_at|date:"d.m.Y H:i" }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% if review.comment %}
                            <p style="
                                color: var(--text-secondary);
                                margin: 0;
                                line-height: 1.6;
                            ">
                                {{ review.comment }}
                            </p>
                        {% else %}
                            <p style="color: var(--text-muted); font-style: italic; margin: 0;">
                                Без комментария
                            </p>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state" style="padding: 3rem;">
                <i data-lucide="message-square" style="width: 60px; height: 60px;"></i>
                <h3>Пока нет отзывов</h3>
                <p>Будьте первым, кто оставит отзыв об этом фильме</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Add Review Form -->
    {% if request.user.is_authenticated %}
        <div style="
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 2.5rem;
        ">
            <h3 style="
                font-size: 1.5rem;
                font-weight: 700;
                margin-bottom: 1.5rem;
                color: var(--text-primary);
            ">
                Оставить отзыв
            </h3>
            
            <form method="post" class="form">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="id_rating" class="form-label">
                        <i data-lucide="star" style="width: 16px; height: 16px;"></i>
                        Оценка
                    </label>
                    <select name="rating" id="id_rating" class="form-input" required>
                        <option value="">Выберите оценку</option>
                        {% for i in "12345" %}
                            <option value="{{ forloop.counter }}" {% if form.rating.value == forloop.counter|stringformat:"s" %}selected{% endif %}>
                                {{ forloop.counter }} звезд{{ forloop.counter|pluralize:"а,ы," }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="id_comment" class="form-label">
                        <i data-lucide="message-square" style="width: 16px; height: 16px;"></i>
                        Комментарий (необязательно)
                    </label>
                    <textarea 
                        name="comment" 
                        id="id_comment" 
                        class="form-input" 
                        rows="5"
                        placeholder="Поделитесь своими впечатлениями о фильме..."
                    >{{ form.comment.value|default:'' }}</textarea>
                </div>
                
                {% if form.errors %}
                    <div style="
                        padding: 1rem 1.5rem;
                        background: rgba(239, 68, 68, 0.1);
                        border: 1px solid rgba(239, 68, 68, 0.3);
                        border-radius: 12px;
                        margin-bottom: 1.5rem;
                    ">
                        {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                                <p style="color: #EF4444; margin: 0.25rem 0;">{{ error }}</p>
                            {% endfor %}
                        {% endfor %}
                    </div>
                {% endif %}
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="send"></i>
                        Отправить отзыв
                    </button>
                </div>
            </form>
        </div>
    {% else %}
        <div style="
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
        ">
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                Чтобы оставить отзыв, пожалуйста, 
                <a href="{% url 'accounts:login' %}" style="color: var(--primary); text-decoration: none; font-weight: 600;">
                    войдите в систему
                </a>
            </p>
        </div>
    {% endif %}
</section>

<script>
    lucide.createIcons();
</script>
{% endblock %}
